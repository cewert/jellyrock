import "pkg:/source/migrations.bs"
import "pkg:/source/utils/config.bs"

namespace tests

  @suite("Splash Setting Removal Migration - v1.5.0")
  @tags("migration")
  class SplashSettingRemovalTests extends tests.BaseTestSuite

    protected override sub setup()
      m.needsRegistrySetup = true
      super.setup()
    end sub

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Splash Setting Removal")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("deletes uiHomeSplashBackground setting when set to true")
    function _()
      ' GIVEN: User on v1.4.0 with splash setting enabled
      testUserId = "test-splash-removal-001"

      reg = CreateObject("roRegistrySection", testUserId)
      reg.write("LastRunVersion", "1.4.0")
      reg.write("serverId", "test-server-123")
      reg.write("uiHomeSplashBackground", "true")
      reg.flush()

      ' WHEN: Migration runs
      runRegistryUserMigrations([testUserId])

      ' THEN: uiHomeSplashBackground is deleted
      reg = CreateObject("roRegistrySection", testUserId)
      m.assertFalse(reg.exists("uiHomeSplashBackground"), "uiHomeSplashBackground should be deleted")
    end function

    @it("deletes uiHomeSplashBackground setting when set to false")
    function _()
      ' GIVEN: User with splash setting disabled
      testUserId = "test-splash-removal-002"

      reg = CreateObject("roRegistrySection", testUserId)
      reg.write("LastRunVersion", "1.4.0")
      reg.write("serverId", "test-server-123")
      reg.write("uiHomeSplashBackground", "false")
      reg.flush()

      ' WHEN: Migration runs
      runRegistryUserMigrations([testUserId])

      ' THEN: uiHomeSplashBackground is deleted
      reg = CreateObject("roRegistrySection", testUserId)
      m.assertFalse(reg.exists("uiHomeSplashBackground"), "uiHomeSplashBackground should be deleted")
    end function

    @it("handles missing uiHomeSplashBackground gracefully")
    function _()
      ' GIVEN: User without splash setting
      testUserId = "test-splash-missing-001"

      reg = CreateObject("roRegistrySection", testUserId)
      reg.write("LastRunVersion", "1.4.0")
      reg.write("serverId", "test-server-123")
      ' Don't write uiHomeSplashBackground
      reg.flush()

      ' WHEN: Migration runs
      runRegistryUserMigrations([testUserId])

      ' THEN: No error occurs, setting still doesn't exist
      reg = CreateObject("roRegistrySection", testUserId)
      m.assertFalse(reg.exists("uiHomeSplashBackground"), "uiHomeSplashBackground should not exist")
    end function

    @it("preserves other user settings during migration")
    function _()
      ' GIVEN: User with multiple settings including splash
      testUserId = "test-preserve-other-001"

      reg = CreateObject("roRegistrySection", testUserId)
      reg.write("LastRunVersion", "1.4.0")
      reg.write("serverId", "test-server-123")
      reg.write("uiHomeSplashBackground", "true")
      reg.write("uiDesignHideClock", "false")
      reg.write("playbackBitrateLimit", "8000")
      reg.flush()

      ' WHEN: Migration runs
      runRegistryUserMigrations([testUserId])

      ' THEN: Only splash setting is deleted, others preserved
      reg = CreateObject("roRegistrySection", testUserId)
      m.assertFalse(reg.exists("uiHomeSplashBackground"), "Splash setting should be deleted")
      m.assertTrue(reg.exists("uiDesignHideClock"), "Other settings should be preserved")
      m.assertEqual(reg.read("uiDesignHideClock"), "false")
      m.assertTrue(reg.exists("playbackBitrateLimit"), "Other settings should be preserved")
      m.assertEqual(reg.read("playbackBitrateLimit"), "8000")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Version Checking")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("skips migration when version already >= v1.5.0")
    function _()
      ' GIVEN: User already on v1.5.0 with splash setting
      testUserId = "test-skip-001"

      reg = CreateObject("roRegistrySection", testUserId)
      reg.write("LastRunVersion", "1.5.0")
      reg.write("serverId", "test-server-123")
      reg.write("uiHomeSplashBackground", "true")
      reg.flush()

      ' WHEN: Migration runs
      runRegistryUserMigrations([testUserId])

      ' THEN: Setting is NOT deleted (migration skipped)
      reg = CreateObject("roRegistrySection", testUserId)
      m.assertTrue(reg.exists("uiHomeSplashBackground"), "Migration should be skipped")
      m.assertEqual(reg.read("uiHomeSplashBackground"), "true")
    end function

    @it("runs migration for version v1.4.0")
    function _()
      ' GIVEN: User on v1.4.0
      testUserId = "test-run-1-4-0"

      reg = CreateObject("roRegistrySection", testUserId)
      reg.write("LastRunVersion", "1.4.0")
      reg.write("serverId", "test-server-123")
      reg.write("uiHomeSplashBackground", "true")
      reg.flush()

      ' WHEN: Migration runs
      runRegistryUserMigrations([testUserId])

      ' THEN: Migration executes and deletes setting
      reg = CreateObject("roRegistrySection", testUserId)
      m.assertFalse(reg.exists("uiHomeSplashBackground"))
    end function

    @it("runs migration for older version v1.0.0")
    function _()
      ' GIVEN: User on very old version
      testUserId = "test-run-1-0-0"

      reg = CreateObject("roRegistrySection", testUserId)
      reg.write("LastRunVersion", "1.0.0")
      reg.write("serverId", "test-server-123")
      reg.write("uiHomeSplashBackground", "false")
      reg.flush()

      ' WHEN: Migration runs
      runRegistryUserMigrations([testUserId])

      ' THEN: Migration executes and deletes setting
      reg = CreateObject("roRegistrySection", testUserId)
      m.assertFalse(reg.exists("uiHomeSplashBackground"))
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Multi-User Independence")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("migrates multiple users independently")
    function _()
      ' GIVEN: Multiple users with different splash setting values
      user1 = "test-multi-user-001"
      user2 = "test-multi-user-002"
      user3 = "test-multi-user-003"

      ' User 1: splash enabled (should be deleted)
      reg1 = CreateObject("roRegistrySection", user1)
      reg1.write("LastRunVersion", "1.4.0")
      reg1.write("serverId", "test-server-123")
      reg1.write("uiHomeSplashBackground", "true")
      reg1.flush()

      ' User 2: splash disabled (should be deleted)
      reg2 = CreateObject("roRegistrySection", user2)
      reg2.write("LastRunVersion", "1.4.0")
      reg2.write("serverId", "test-server-123")
      reg2.write("uiHomeSplashBackground", "false")
      reg2.flush()

      ' User 3: no splash setting (nothing to delete)
      reg3 = CreateObject("roRegistrySection", user3)
      reg3.write("LastRunVersion", "1.4.0")
      reg3.write("serverId", "test-server-123")
      reg3.flush()

      ' WHEN: All users migrate
      runRegistryUserMigrations([user1, user2, user3])

      ' THEN: Each user migrated correctly
      reg1 = CreateObject("roRegistrySection", user1)
      m.assertFalse(reg1.exists("uiHomeSplashBackground"), "User 1 setting should be deleted")

      reg2 = CreateObject("roRegistrySection", user2)
      m.assertFalse(reg2.exists("uiHomeSplashBackground"), "User 2 setting should be deleted")

      reg3 = CreateObject("roRegistrySection", user3)
      m.assertFalse(reg3.exists("uiHomeSplashBackground"), "User 3 should still have no setting")
    end function

  end class

end namespace

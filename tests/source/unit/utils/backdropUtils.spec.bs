import "pkg:/source/utils/backdropUtils.bs"
import "pkg:/source/utils/misc.bs"

namespace tests

  @suite("backdropUtils.bs - getBackdropUrl()")
  class BackdropUtilsTests extends tests.BaseTestSuite

    protected override function setup()
      super.setup()
      ' Standard device resolutions for testing
      m.resolution1080p = [1920, 1080]
      m.resolution4K = [3840, 2160]
      m.resolution720p = [1280, 720]

      ' Load all mock data scenarios using MockDataLoader
      m.movieScenarios = MockDataLoader.LoadBackdropScenarios("movie-scenarios")
      m.seriesScenarios = MockDataLoader.LoadBackdropScenarios("series-scenarios")
      m.episodeScenarios = MockDataLoader.LoadBackdropScenarios("episode-scenarios")
      m.albumScenarios = MockDataLoader.LoadBackdropScenarios("music-album-scenarios")
      m.artistScenarios = MockDataLoader.LoadBackdropScenarios("music-artist-scenarios")
      m.audioScenarios = MockDataLoader.LoadBackdropScenarios("audio-scenarios")
      m.otherMediaScenarios = MockDataLoader.LoadBackdropScenarios("other-media-scenarios")
    end function

    ' Helper function to find scenario by name from array
    function findScenario(scenarios as object, scenarioName as string) as object
      if not isValid(scenarios)
        throw "findScenario: scenarios array is invalid"
      end if

      for each scenario in scenarios
        if scenario._scenario = scenarioName
          return scenario
        end if
      end for

      ' Scenario not found - throw error with helpful message
      throw "findScenario: Could not find scenario '" + scenarioName + "'"
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Input Validation & Edge Cases")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns empty string when datum is invalid")
    function _()
      result = getBackdropUrl(invalid, m.resolution1080p)
      m.assertEqual(result, "")
    end function

    @it("returns empty string when deviceResolution is invalid")
    function _()
      datum = { Type: "Movie", Id: "test-123" }
      result = getBackdropUrl(datum, invalid)
      m.assertEqual(result, "")
    end function

    @it("returns empty string when datum.type is missing")
    function _()
      datum = { Id: "test-123", BackdropImageTags: ["valid-tag"] }
      result = getBackdropUrl(datum, m.resolution1080p)
      m.assertEqual(result, "")
    end function

    @it("returns empty string when BackdropImageTags is empty array")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)
      m.assertEqual(result, "")
    end function

    @it("returns empty string when BackdropImageTags[0] is empty string")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-empty-backdrop-tag")
      result = getBackdropUrl(datum, m.resolution1080p)
      m.assertEqual(result, "")
    end function

    @it("returns empty string when BackdropImageTags[0] is whitespace")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-whitespace-backdrop-tag")
      result = getBackdropUrl(datum, m.resolution1080p)
      m.assertEqual(result, "")
    end function

    @it("never returns invalid - only string")
    function _()
      ' Test with various invalid inputs
      result1 = getBackdropUrl(invalid, m.resolution1080p)
      result2 = getBackdropUrl({ Type: "Movie" }, invalid)
      result3 = getBackdropUrl({ Id: "test" }, m.resolution1080p)

      m.assertTrue(isValid(result1), "Result should be valid string, not invalid")
      m.assertTrue(isValid(result2), "Result should be valid string, not invalid")
      m.assertTrue(isValid(result3), "Result should be valid string, not invalid")
      ' BrightScript literal strings return "String" from Type(), not "roString"
      m.assertEqual(Type(result1), "String")
      m.assertEqual(Type(result2), "String")
      m.assertEqual(Type(result3), "String")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Device Resolution Usage")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("uses device resolution in generated backdrop URL")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      ' URL should contain maxWidth and maxHeight parameters from device resolution
      m.assertNotEqual(result, "", "Should generate valid URL")
      m.assertTrue(result.Instr("maxWidth=1920") >= 0, "URL should contain maxWidth from device resolution")
      m.assertTrue(result.Instr("maxHeight=1080") >= 0, "URL should contain maxHeight from device resolution")
    end function

    @it("works with different device resolutions")
    @params([1920, 1080], "maxWidth=1920", "maxHeight=1080")
    @params([3840, 2160], "maxWidth=3840", "maxHeight=2160")
    @params([1280, 720], "maxWidth=1280", "maxHeight=720")
    function _(resolution, expectedWidth, expectedHeight)
      datum = m.findScenario(m.movieScenarios, "movie-with-backdrop")
      result = getBackdropUrl(datum, resolution)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(expectedWidth) >= 0, "URL should contain correct width")
      m.assertTrue(result.Instr(expectedHeight) >= 0, "URL should contain correct height")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Movie Backdrops")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns valid URL when movie has backdrop")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain item ID")
      m.assertTrue(result.Instr("backdrop-tag-abc123") >= 0, "URL should contain backdrop tag")
    end function

    @it("returns empty string when movie has no backdrop")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    @it("handles movie type case insensitively")
    @params("movie-with-backdrop")
    @params("movie-uppercase-type")
    @params("movie-mixedcase-type")
    function _(scenarioName)
      datum = m.findScenario(m.movieScenarios, scenarioName)
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "", "Should generate URL regardless of type casing")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain item ID")
    end function

    @it("uses first backdrop when multiple BackdropImageTags exist")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-multiple-backdrops")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr("first-backdrop-tag") >= 0, "Should use first tag from array")
      m.assertFalse(result.Instr("second-backdrop-tag") >= 0, "Should not use second tag")
      m.assertFalse(result.Instr("third-backdrop-tag") >= 0, "Should not use third tag")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Series Backdrops")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns valid URL when series has backdrop")
    function _()
      datum = m.findScenario(m.seriesScenarios, "series-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain item ID")
      m.assertTrue(result.Instr("series-backdrop-tag-xyz789") >= 0, "URL should contain backdrop tag")
    end function

    @it("returns empty string when series has no backdrop")
    function _()
      datum = m.findScenario(m.seriesScenarios, "series-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Episode Backdrops - Fallback Logic")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns parent backdrop URL when ParentBackdropImageTags exists")
    function _()
      datum = m.findScenario(m.episodeScenarios, "episode-with-parent-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.ParentBackdropItemId) >= 0, "URL should contain parent item ID")
      m.assertTrue(result.Instr("parent-series-backdrop-tag") >= 0, "URL should contain parent backdrop tag")
    end function

    @it("returns own backdrop URL when only own BackdropImageTags exists")
    function _()
      datum = m.findScenario(m.episodeScenarios, "episode-with-own-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain episode ID")
      m.assertTrue(result.Instr("episode-own-backdrop-tag") >= 0, "URL should contain episode backdrop tag")
    end function

    @it("prioritizes parent backdrop over own backdrop")
    function _()
      datum = m.findScenario(m.episodeScenarios, "episode-with-both-backdrops")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      ' Should use parent backdrop (priority)
      m.assertTrue(result.Instr(datum.ParentBackdropItemId) >= 0, "URL should contain parent item ID")
      m.assertTrue(result.Instr("parent-series-backdrop-tag-priority") >= 0, "URL should use parent tag")
      ' Should NOT use own backdrop
      m.assertFalse(result.Instr("episode-own-backdrop-tag-lower-priority") >= 0, "Should not use episode's own tag")
    end function

    @it("returns empty string when neither parent nor own backdrop exists")
    function _()
      datum = m.findScenario(m.episodeScenarios, "episode-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    @it("falls back to own backdrop when ParentBackdropItemId is missing")
    function _()
      datum = m.findScenario(m.episodeScenarios, "episode-parent-tag-missing-id")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      ' Should fall back to episode's own backdrop
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain episode ID as fallback")
      m.assertTrue(result.Instr("episode-fallback-tag") >= 0, "URL should use episode's own tag")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Recording Backdrops - Same as Episode")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("follows same fallback logic as Episode")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "recording-with-parent-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.ParentBackdropItemId) >= 0, "Should use parent backdrop")
      m.assertTrue(result.Instr("recording-parent-backdrop-tag") >= 0)
    end function

    @it("returns empty string when recording has no backdrop")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "recording-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("MusicVideo Backdrops - Same as Episode")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("follows same fallback logic as Episode")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "musicvideo-with-parent-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.ParentBackdropItemId) >= 0, "Should use parent backdrop")
      m.assertTrue(result.Instr("musicvideo-parent-backdrop-tag") >= 0)
    end function

    @it("returns empty string when music video has no backdrop")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "musicvideo-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Program (LiveTV) Backdrops")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns parent backdrop URL when available")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "program-with-parent-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.ParentBackdropItemId) >= 0, "Should use parent backdrop")
      m.assertTrue(result.Instr("program-parent-backdrop-tag") >= 0)
    end function

    @it("returns empty string when no backdrop exists")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "program-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Video Backdrops")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns valid URL when video has backdrop")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "video-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain item ID")
      m.assertTrue(result.Instr("video-backdrop-tag") >= 0)
    end function

    @it("returns empty string when video has no backdrop")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "video-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("MusicAlbum Backdrops - Fallback Logic")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns own backdrop URL when album has backdrop")
    function _()
      datum = m.findScenario(m.albumScenarios, "album-with-own-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain album ID")
      m.assertTrue(result.Instr("album-own-backdrop-tag") >= 0)
    end function

    @it("returns parent artist backdrop URL when album has no backdrop but artist does")
    function _()
      datum = m.findScenario(m.albumScenarios, "album-with-parent-artist-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.ParentBackdropItemId) >= 0, "URL should contain artist ID")
      m.assertTrue(result.Instr("artist-backdrop-tag") >= 0)
    end function

    @it("prioritizes own backdrop over parent artist backdrop")
    function _()
      datum = m.findScenario(m.albumScenarios, "album-with-both-backdrops")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      ' Should use album's own backdrop (priority)
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain album ID")
      m.assertTrue(result.Instr("album-own-backdrop-priority") >= 0, "URL should use album's own tag")
      ' Should NOT use parent artist backdrop
      m.assertFalse(result.Instr("artist-backdrop-lower-priority") >= 0, "Should not use artist tag")
    end function

    @it("returns empty string when neither album nor artist has backdrop")
    function _()
      datum = m.findScenario(m.albumScenarios, "album-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("MusicArtist Backdrops")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns valid URL when artist has backdrop")
    function _()
      datum = m.findScenario(m.artistScenarios, "artist-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain artist ID")
      m.assertTrue(result.Instr("artist-backdrop-tag-def456") >= 0)
    end function

    @it("returns empty string when artist has no backdrop")
    function _()
      datum = m.findScenario(m.artistScenarios, "artist-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Audio (Song) Backdrops - Fallback Logic")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns own backdrop URL when song has backdrop")
    function _()
      datum = m.findScenario(m.audioScenarios, "audio-with-own-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain song ID")
      m.assertTrue(result.Instr("song-own-backdrop-tag") >= 0)
    end function

    @it("returns album backdrop URL via ParentBackdropImageTags when song has no backdrop")
    function _()
      datum = m.findScenario(m.audioScenarios, "audio-with-album-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.ParentBackdropItemId) >= 0, "URL should contain album ID")
      m.assertTrue(result.Instr("album-backdrop-tag") >= 0)
    end function

    @it("prioritizes own backdrop over album backdrop")
    function _()
      datum = m.findScenario(m.audioScenarios, "audio-with-both-backdrops")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      ' Should use song's own backdrop (priority)
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain song ID")
      m.assertTrue(result.Instr("song-own-backdrop-priority") >= 0, "URL should use song's own tag")
      ' Should NOT use album backdrop
      m.assertFalse(result.Instr("album-backdrop-lower-priority") >= 0, "Should not use album tag")
    end function

    @it("returns empty string when neither song nor album has backdrop")
    function _()
      datum = m.findScenario(m.audioScenarios, "audio-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    @it("returns empty string when ParentBackdropImageTags exists but ParentBackdropItemId missing")
    function _()
      datum = m.findScenario(m.audioScenarios, "audio-parent-tag-missing-id")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "", "Should return empty when parent tag exists but parent ID missing")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("CollectionFolder/UserView Backdrops")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns valid URL when collection has backdrop")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "collectionfolder-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain collection ID")
      m.assertTrue(result.Instr("collection-backdrop-tag") >= 0)
    end function

    @it("returns empty string when collection has no backdrop")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "collectionfolder-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    @it("returns valid URL when userview has backdrop")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "userview-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL should contain userview ID")
      m.assertTrue(result.Instr("userview-backdrop-tag") >= 0)
    end function

    @it("returns empty string when userview has no backdrop")
    function _()
      datum = m.findScenario(m.otherMediaScenarios, "userview-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result, "")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("URL Format Validation")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returned URL contains item ID")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr(datum.Id) >= 0, "URL must contain item ID")
    end function

    @it("returned URL contains backdrop tag")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      ' ImageURL uses capital "Tag" in params, check case-insensitively
      m.assertTrue(result.Instr("backdrop-tag-abc123") >= 0, "URL must contain backdrop tag value")
    end function

    @it("returned URL contains maxWidth parameter")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr("maxWidth=") >= 0, "URL must contain maxWidth parameter")
    end function

    @it("returned URL contains maxHeight parameter")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-with-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertNotEqual(result, "")
      m.assertTrue(result.Instr("maxHeight=") >= 0, "URL must contain maxHeight parameter")
    end function

    @it("empty string result has zero length")
    function _()
      datum = m.findScenario(m.movieScenarios, "movie-without-backdrop")
      result = getBackdropUrl(datum, m.resolution1080p)

      m.assertEqual(result.Len(), 0, "Empty result should have zero length")
    end function

  end class

end namespace

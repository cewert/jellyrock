
namespace tests

  @suite("nodeHelpers.bs - createQueueItem Utility")
  class NodeHelpersCreateQueueItemTests extends tests.BaseTestSuite

    protected override function setup()
      super.setup()
    end function

    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("createQueueItem(sourceNode) - input validation")
    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns invalid when sourceNode is invalid")
    function _()
      result = nodeHelpers.createQueueItem(invalid)
      m.assertInvalid(result)
    end function

    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("createQueueItem(sourceNode) - return type")
    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns an associative array, not an SGNode")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test Movie" }
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertNotInvalid(queueItem)
      ' Verify it's an AA by checking it has the count() method
      m.assertNotInvalid(queueItem.count())
      ' SGNodes have subtype(), AAs return invalid when accessing non-existent method
      m.assertInvalid(queueItem.subtype)
    end function

    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("createQueueItem(sourceNode) - required fields")
    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("copies id field when present")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "movie-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" }
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertEqual(queueItem.id, "movie-123")
    end function

    @it("copies type field when present")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Episode",
        json: { name: "Test" }
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertEqual(queueItem.type, "Episode")
    end function

    @it("copies json field when present")
    function _()
      jsonData = {
        id: "123",
        name: "Test Movie",
        MediaStreams: [{ index: 0 }]
      }

      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: jsonData
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertNotInvalid(queueItem.json)
      m.assertEqual(queueItem.json.id, "123")
      m.assertEqual(queueItem.json.name, "Test Movie")
      m.assertNotInvalid(queueItem.json.MediaStreams)
    end function

    @it("handles missing id field gracefully")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      ' Don't set id, leave it as default empty string
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" }
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertNotInvalid(queueItem)
      ' id will be empty string (ContentNode default), which won't be copied
      m.assertTrue(NOT queueItem.DoesExist("id") or queueItem.id = "")
    end function

    @it("handles missing type field gracefully")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        json: { name: "Test" }
      })
      ' type field doesn't exist on sourceNode

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertNotInvalid(queueItem)
      ' type should not exist in the AA
      m.assertFalse(queueItem.DoesExist("type"))
    end function

    @it("handles missing json field gracefully")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie"
      })
      ' json field doesn't exist on sourceNode

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertNotInvalid(queueItem)
      ' json should not exist in the AA
      m.assertFalse(queueItem.DoesExist("json"))
    end function

    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("createQueueItem(sourceNode) - optional fields")
    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("copies title field when present")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" },
        title: "Movie Title"
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertEqual(queueItem.title, "Movie Title")
    end function

    @it("copies mediaSourceId field when present")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" },
        mediaSourceId: "source-456"
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertEqual(queueItem.mediaSourceId, "source-456")
    end function

    @it("copies RunTimeTicks field when present")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" },
        RunTimeTicks: 36000000000&
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertEqual(queueItem.RunTimeTicks, 36000000000&)
    end function

    @it("omits title when not present")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" }
      })
      ' Explicitly clear title if ContentNode has default
      sourceNode.title = ""

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      ' Title should either not exist or be empty (not copied from empty source)
      m.assertTrue(NOT queueItem.DoesExist("title") OR queueItem.title = "")
    end function

    @it("omits mediaSourceId when not present")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" }
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertFalse(queueItem.DoesExist("mediaSourceId"))
    end function

    @it("omits RunTimeTicks when not present")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" }
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertFalse(queueItem.DoesExist("RunTimeTicks"))
    end function

    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("createQueueItem(sourceNode) - all fields together")
    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("copies all fields when all are present")
    function _()
      jsonData = {
        id: "jellyfin-123",
        name: "The Matrix",
        MediaStreams: [{ type: "Video" }, { type: "Audio" }]
      }

      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: jsonData,
        title: "The Matrix",
        mediaSourceId: "source-abc",
        RunTimeTicks: 82140000000&
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      ' Verify all required fields
      m.assertEqual(queueItem.id, "test-123")
      m.assertEqual(queueItem.type, "Movie")
      m.assertNotInvalid(queueItem.json)
      m.assertEqual(queueItem.json.name, "The Matrix")

      ' Verify all optional fields
      m.assertEqual(queueItem.title, "The Matrix")
      m.assertEqual(queueItem.mediaSourceId, "source-abc")
      m.assertEqual(queueItem.RunTimeTicks, 82140000000&)
    end function

    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("createQueueItem(sourceNode) - independence")
    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("creates independent item that doesn't affect source when modified")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "original-id"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Original" },
        title: "Original Title"
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      ' Modify the queue item
      queueItem.id = "modified-id"
      queueItem.type = "Episode"
      queueItem.title = "Modified Title"

      ' Source should remain unchanged
      m.assertEqual(sourceNode.id, "original-id")
      m.assertEqual(sourceNode.type, "Movie")
      m.assertEqual(sourceNode.title, "Original Title")
    end function

    @it("source modifications don't affect returned queue item")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" },
        title: "Original"
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      ' Modify source after creating queue item
      sourceNode.id = "changed-456"
      sourceNode.type = "Episode"
      sourceNode.title = "Changed"

      ' Queue item should retain original values
      m.assertEqual(queueItem.id, "test-123")
      m.assertEqual(queueItem.type, "Movie")
      m.assertEqual(queueItem.title, "Original")
    end function

    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("createQueueItem(sourceNode) - ignores extra fields")
    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("only copies the 6 specific fields, ignoring all others")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" },
        title: "Test Title",
        mediaSourceId: "source-123",
        RunTimeTicks: 1000&,
        ' Extra fields that should NOT be copied
        extraField1: "should not copy",
        extraField2: 12345,
        focusable: true,
        visible: false
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      ' Should have the 6 expected fields
      m.assertEqual(queueItem.id, "test-123")
      m.assertEqual(queueItem.type, "Movie")
      m.assertNotInvalid(queueItem.json)
      m.assertEqual(queueItem.title, "Test Title")
      m.assertEqual(queueItem.mediaSourceId, "source-123")
      m.assertEqual(queueItem.RunTimeTicks, 1000&)

      ' Should NOT have extra fields
      m.assertFalse(queueItem.DoesExist("extraField1"))
      m.assertFalse(queueItem.DoesExist("extraField2"))
      m.assertFalse(queueItem.DoesExist("focusable"))
      m.assertFalse(queueItem.DoesExist("visible"))
    end function

    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("createQueueItem(sourceNode) - real-world scenarios")
    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("handles SearchData node from search results")
    function _()
      ' Simulate a SearchData node with complex structure
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "episode-123"
      sourceNode.addFields({
        type: "Episode",
        json: {
          id: "episode-123",
          name: "Pilot",
          SeriesName: "Test Show",
          MediaStreams: [{ type: "Video" }],
          UserData: { PlaybackPositionTicks: 0& }
        },
        title: "Pilot"
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      m.assertNotInvalid(queueItem)
      m.assertEqual(queueItem.id, "episode-123")
      m.assertEqual(queueItem.type, "Episode")
      m.assertEqual(queueItem.title, "Pilot")
      m.assertNotInvalid(queueItem.json)
      m.assertEqual(queueItem.json.SeriesName, "Test Show")
    end function

    @it("allows additional fields to be set after creation")
    function _()
      sourceNode = CreateObject("roSGNode", "ContentNode")
      sourceNode.id = "test-123"
      sourceNode.addFields({
        type: "Movie",
        json: { name: "Test" }
      })

      queueItem = nodeHelpers.createQueueItem(sourceNode)

      ' These fields are set by quickplay after createQueueItem
      queueItem.selectedAudioStreamIndex = 2
      queueItem.startingPoint = 15000000000&

      m.assertEqual(queueItem.selectedAudioStreamIndex, 2)
      m.assertEqual(queueItem.startingPoint, 15000000000&)
      ' Original source should not have these fields added
      m.assertInvalid(sourceNode.selectedAudioStreamIndex)
      m.assertInvalid(sourceNode.startingPoint)
    end function

  end class

end namespace

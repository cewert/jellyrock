import "pkg:/source/utils/queueBackdropHelper.bs"
import "pkg:/source/utils/backdropUtils.bs"

namespace tests

  @suite("queueBackdropHelper.bs - updateQueueBackdrop()")
  class QueueBackdropHelperTests extends tests.BaseTestSuite

    private mockQueueManager
    private mockSceneManager
    private lastBackgroundImageCall

    protected override function setup()
      super.setup()

      ' Standard device resolutions for testing
      m.resolution1080p = [1920, 1080]
      m.resolution4K = [3840, 2160]
      m.resolution720p = [1280, 720]

      ' Set default resolution
      m.global.device.addFields({ uiResolution: m.resolution1080p })

      ' Create mock queue manager node with callable function
      m.mockQueueManager = CreateObject("roSGNode", "ContentNode")
      m.global.addFields({ queueManager: m.mockQueueManager })

      ' Create mock scene manager node
      m.mockSceneManager = CreateObject("roSGNode", "ContentNode")
      m.global.addFields({ sceneManager: m.mockSceneManager })

      ' Track background image calls
      m.lastBackgroundImageCall = invalid
    end function

    ' Helper to create a mock queue item with backdrop
    private function createMockQueueItem(itemType as string, hasBackdrop as boolean) as object
      item = {
        json: {
          Type: itemType,
          Id: "test-item-" + itemType
        }
      }

      if hasBackdrop
        item.json.BackdropImageTags = ["test-backdrop-tag-123"]
      else
        item.json.BackdropImageTags = []
      end if

      return item
    end function

    ' Helper to set what getCurrentItem returns
    private function setCurrentQueueItem(item as dynamic) as void
      ' Store in a way that can be accessed by getCurrentItem mock
      m.mockQueueManager.addFields({ mockCurrentItem: item })
    end function

    ' Helper to set what setBackgroundImage was called with
    private function setBackgroundImageCalled(url as string) as void
      m.lastBackgroundImageCall = url
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Input Validation & Edge Cases")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("clears backdrop when queue manager returns invalid current item")
    function _()
      ' Setup: No current item
      m.setCurrentQueueItem(invalid)

      ' Mock getCurrentItem to return invalid
      m.mockQueueManager.addFields({
        getCurrentItemResult: invalid
      })

      ' Note: This test verifies the LOGIC of what SHOULD happen
      ' In actual runtime, sceneManager.callFunc would be called
      ' For unit tests, we verify the conditional logic paths

      ' Execute - we can't easily test callFunc in unit tests, so we test the logic
      ' The function should check if currentItem is invalid and call setBackgroundImage("")
      currentItem = invalid
      shouldClearBackdrop = not isValid(currentItem)

      m.assertTrue(shouldClearBackdrop, "Should clear backdrop when currentItem is invalid")
    end function

    @it("clears backdrop when current item has no backdrop data")
    function _()
      ' Setup: Item with no backdrop
      item = m.createMockQueueItem("Movie", false)
      m.setCurrentQueueItem(item)

      ' Get backdrop URL for this item
      backdropUrl = getBackdropUrl(item.json, m.global.device.uiResolution)

      m.assertEqual(backdropUrl, "", "Should return empty string for item without backdrop")
    end function

    @it("clears backdrop when current item json is invalid")
    function _()
      ' Setup: Item with invalid json
      item = { json: invalid }

      ' Get backdrop URL for this item
      backdropUrl = getBackdropUrl(item.json, m.global.device.uiResolution)

      m.assertEqual(backdropUrl, "", "Should return empty string for invalid json")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Backdrop URL Generation")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("generates backdrop URL when current item has backdrop")
    function _()
      ' Setup: Movie item with backdrop
      item = m.createMockQueueItem("Movie", true)

      ' Generate backdrop URL
      backdropUrl = getBackdropUrl(item.json, m.global.device.uiResolution)

      m.assertNotEqual(backdropUrl, "", "Should generate valid backdrop URL")
      m.assertTrue(backdropUrl.Instr("test-item-Movie") >= 0, "URL should contain item ID")
      m.assertTrue(backdropUrl.Instr("test-backdrop-tag-123") >= 0, "URL should contain backdrop tag")
    end function

    @it("uses device resolution in backdrop URL")
    function _()
      ' Setup: Movie item with backdrop
      item = m.createMockQueueItem("Movie", true)

      ' Generate backdrop URL with 1080p resolution
      backdropUrl = getBackdropUrl(item.json, m.resolution1080p)

      m.assertNotEqual(backdropUrl, "")
      m.assertTrue(backdropUrl.Instr("maxWidth=1920") >= 0, "URL should contain 1080p width")
      m.assertTrue(backdropUrl.Instr("maxHeight=1080") >= 0, "URL should contain 1080p height")
    end function

    @it("generates backdrop URL for different media types")
    @params("Movie", true)
    @params("Series", true)
    @params("Video", true)
    @params("MusicAlbum", true)
    @params("MusicArtist", true)
    function _(itemType, shouldHaveBackdrop)
      ' Setup: Item with backdrop
      item = m.createMockQueueItem(itemType, shouldHaveBackdrop)

      ' Generate backdrop URL
      backdropUrl = getBackdropUrl(item.json, m.global.device.uiResolution)

      if shouldHaveBackdrop
        m.assertNotEqual(backdropUrl, "", "Should generate backdrop URL for " + itemType)
        m.assertTrue(backdropUrl.Instr("test-item-" + itemType) >= 0, "URL should contain item ID")
      else
        m.assertEqual(backdropUrl, "", "Should return empty string when no backdrop")
      end if
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Device Resolution Handling")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("uses 1080p resolution correctly")
    function _()
      item = m.createMockQueueItem("Movie", true)
      backdropUrl = getBackdropUrl(item.json, m.resolution1080p)

      m.assertTrue(backdropUrl.Instr("maxWidth=1920") >= 0)
      m.assertTrue(backdropUrl.Instr("maxHeight=1080") >= 0)
    end function

    @it("uses 4K resolution correctly")
    function _()
      item = m.createMockQueueItem("Movie", true)
      backdropUrl = getBackdropUrl(item.json, m.resolution4K)

      m.assertTrue(backdropUrl.Instr("maxWidth=3840") >= 0)
      m.assertTrue(backdropUrl.Instr("maxHeight=2160") >= 0)
    end function

    @it("uses 720p resolution correctly")
    function _()
      item = m.createMockQueueItem("Movie", true)
      backdropUrl = getBackdropUrl(item.json, m.resolution720p)

      m.assertTrue(backdropUrl.Instr("maxWidth=1280") >= 0)
      m.assertTrue(backdropUrl.Instr("maxHeight=720") >= 0)
    end function

    @it("handles different resolutions for same item")
    @params([1920, 1080], "maxWidth=1920", "maxHeight=1080")
    @params([3840, 2160], "maxWidth=3840", "maxHeight=2160")
    @params([1280, 720], "maxWidth=1280", "maxHeight=720")
    function _(resolution, expectedWidth, expectedHeight)
      item = m.createMockQueueItem("Movie", true)
      backdropUrl = getBackdropUrl(item.json, resolution)

      m.assertNotEqual(backdropUrl, "")
      m.assertTrue(backdropUrl.Instr(expectedWidth) >= 0, "Should contain correct width")
      m.assertTrue(backdropUrl.Instr(expectedHeight) >= 0, "Should contain correct height")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Empty and Invalid Backdrop Handling")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("returns empty string when backdrop tag is empty string")
    function _()
      item = {
        json: {
          Type: "Movie",
          Id: "test-movie",
          BackdropImageTags: [""]
        }
      }

      backdropUrl = getBackdropUrl(item.json, m.resolution1080p)
      m.assertEqual(backdropUrl, "")
    end function

    @it("returns empty string when backdrop tag array is empty")
    function _()
      item = {
        json: {
          Type: "Movie",
          Id: "test-movie",
          BackdropImageTags: []
        }
      }

      backdropUrl = getBackdropUrl(item.json, m.resolution1080p)
      m.assertEqual(backdropUrl, "")
    end function

    @it("returns empty string when BackdropImageTags is missing")
    function _()
      item = {
        json: {
          Type: "Movie",
          Id: "test-movie"
        }
      }

      backdropUrl = getBackdropUrl(item.json, m.resolution1080p)
      m.assertEqual(backdropUrl, "")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Episode Backdrop Logic")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("uses parent backdrop for episodes when available")
    function _()
      item = {
        json: {
          Type: "Episode",
          Id: "episode-123",
          ParentBackdropImageTags: ["parent-backdrop-tag"],
          ParentBackdropItemId: "series-456"
        }
      }

      backdropUrl = getBackdropUrl(item.json, m.resolution1080p)

      m.assertNotEqual(backdropUrl, "")
      m.assertTrue(backdropUrl.Instr("series-456") >= 0, "Should use parent series ID")
      m.assertTrue(backdropUrl.Instr("parent-backdrop-tag") >= 0, "Should use parent backdrop tag")
    end function

    @it("falls back to episode own backdrop when no parent backdrop")
    function _()
      item = {
        json: {
          Type: "Episode",
          Id: "episode-123",
          BackdropImageTags: ["episode-backdrop-tag"]
        }
      }

      backdropUrl = getBackdropUrl(item.json, m.resolution1080p)

      m.assertNotEqual(backdropUrl, "")
      m.assertTrue(backdropUrl.Instr("episode-123") >= 0, "Should use episode ID")
      m.assertTrue(backdropUrl.Instr("episode-backdrop-tag") >= 0, "Should use episode backdrop tag")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Function Logic Verification")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("verifies backdrop should be cleared for invalid items")
    function _()
      ' Test the conditional logic that updateQueueBackdrop uses
      currentItem = invalid

      ' This is the logic from updateQueueBackdrop
      shouldClearBackdrop = not isValid(currentItem)

      m.assertTrue(shouldClearBackdrop, "Should clear backdrop when item is invalid")
    end function

    @it("verifies backdrop should be cleared for empty URL")
    function _()
      ' Test the conditional logic that updateQueueBackdrop uses
      backdropUrl = ""

      ' This is the logic from updateQueueBackdrop
      shouldClearBackdrop = (backdropUrl = "" or not isValid(backdropUrl))

      m.assertTrue(shouldClearBackdrop, "Should clear backdrop when URL is empty string")
    end function

    @it("verifies backdrop should be cleared for invalid URL")
    function _()
      ' Test the conditional logic that updateQueueBackdrop uses
      backdropUrl = invalid

      ' This is the logic from updateQueueBackdrop
      shouldClearBackdrop = (backdropUrl = "" or not isValid(backdropUrl))

      m.assertTrue(shouldClearBackdrop, "Should clear backdrop when URL is invalid")
    end function

    @it("verifies backdrop should be set for valid URL")
    function _()
      ' Test the conditional logic that updateQueueBackdrop uses
      backdropUrl = "http://example.com/backdrop.jpg"

      ' This is the logic from updateQueueBackdrop
      shouldSetBackdrop = backdropUrl <> "" and isValid(backdropUrl)

      m.assertTrue(shouldSetBackdrop, "Should set backdrop when URL is valid and non-empty")
    end function

  end class

end namespace

import "pkg:/source/api/Items.bs"
import "pkg:/source/utils/misc.bs"

namespace tests

  @suite("Items.bs - ItemPostPlaybackInfo() DOVI Logic")
  class ItemsDoviHandlingTests extends tests.BaseTestSuite

    protected override function setup()
      super.setup()
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("DOVI Detection Logic")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("detects DOVI in VideoRangeType with case insensitivity")
    function _()
      ' Given: Various DOVI VideoRangeType values
      doviValues = ["DOVI", "dovi", "DOVIWithSDR", "doviwithsdr", "DOVIHLG", "DOVIWithHDR10", "DOVIHDR10"]

      for each doviValue in doviValues
        ' When: Check for DOVI substring
        hasDovi = Instr(LCase(doviValue), "dovi") > 0

        ' Then: All should be detected as DOVI
        m.assertTrue(hasDovi, "Should detect DOVI in: " + doviValue)
      end for
    end function

    @it("does not detect SDR as DOVI")
    function _()
      ' Given: SDR VideoRangeType
      sdrValue = "SDR"

      ' When: Check for DOVI substring
      hasDovi = Instr(LCase(sdrValue), "dovi") > 0

      ' Then: Should not be detected as DOVI
      m.assertFalse(hasDovi, "Should not detect DOVI in SDR")
    end function

    @it("does not detect HDR10 as DOVI")
    function _()
      ' Given: HDR10 VideoRangeType
      hdr10Value = "HDR10"

      ' When: Check for DOVI substring
      hasDovi = Instr(LCase(hdr10Value), "dovi") > 0

      ' Then: Should not be detected as DOVI
      m.assertFalse(hasDovi, "Should not detect DOVI in HDR10")
    end function

    @it("does not detect empty VideoRangeType as DOVI")
    function _()
      ' Given: Empty VideoRangeType
      emptyValue = ""

      ' When: Check for DOVI substring
      hasDovi = Instr(LCase(emptyValue), "dovi") > 0

      ' Then: Should not be detected as DOVI
      m.assertFalse(hasDovi, "Should not detect DOVI in empty string")
    end function

    @it("preserves original case when creating container profile")
    function _()
      ' Given: Mixed case DOVI VideoRangeType
      originalValue = "DOVIwithHDR10"

      ' When: Store in container profile (should preserve original case)
      containerProfile = {
        VideoRangeType: originalValue
      }

      ' Then: Original case should be preserved
      m.assertEqual(containerProfile.VideoRangeType, originalValue, "Should preserve original case")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Media Stream Processing")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("processes first video stream when multiple streams exist")
    function _()
      ' Given: Media streams with multiple video streams
      mediaStreams = [
        {
          Type: "Video",
          VideoRangeType: "DOVIWithSDR"
        },
        {
          Type: "Video",
          VideoRangeType: "SDR"
        },
        {
          Type: "Audio",
          Codec: "aac"
        }
      ]

      ' When: Process media streams (simulating the ItemPostPlaybackInfo logic)
      processedFirstVideo = false
      for each stream in mediaStreams
        if stream.Type = "Video"
          ' Process only the first video stream
          processedFirstVideo = true
          m.assertEqual(stream.VideoRangeType, "DOVIWithSDR", "Should process first video stream")
          exit for
        end if
      end for

      ' Then: Only first video stream should be processed
      m.assertTrue(processedFirstVideo, "Should have processed a video stream")
    end function

    @it("ignores streams without Type field")
    function _()
      ' Given: Media streams with missing Type field
      mediaStreams = [
        {
          VideoRangeType: "DOVIWithSDR"
          ' Missing Type field
        }
      ]

      ' When: Process media streams
      hasVideoStream = false
      for each stream in mediaStreams
        if stream.Type = "Video"
          hasVideoStream = true
        end if
      end for

      ' Then: Should be ignored
      m.assertFalse(hasVideoStream, "Should not find video streams without Type field")
    end function

    @it("handles missing VideoRangeType field gracefully")
    function _()
      ' Given: Video stream without VideoRangeType
      mediaStreams = [
        {
          Type: "Video"
          ' Missing VideoRangeType
        }
      ]

      ' When: Check for DOVI (should handle missing field)
      cantProcessDOVI = true
      for each stream in mediaStreams
        if stream.Type = "Video"
          if stream.DoesExist("VideoRangeType") and stream.VideoRangeType <> ""
            cantProcessDOVI = false
          end if
        end if
      end for

      ' Then: Should not process DOVI logic
      m.assertTrue(cantProcessDOVI, "Should skip streams without VideoRangeType")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Container Profile Structure")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("creates correct container profile structure")
    function _()
      ' Given: DOVI content in MKV container
      videoRangeType = "DOVIWithHDR10"

      ' When: Create container profile for DOVI
      containerProfile = {
        Type: "Video",
        Container: "mkv",
        Conditions: [
          {
            Condition: "NotEquals",
            Property: "VideoRangeType",
            Value: videoRangeType,
            IsRequired: true
          }
        ]
      }

      ' Then: Profile structure should be correct
      m.assertEqual(containerProfile.Type, "Video")
      m.assertEqual(containerProfile.Container, "mkv")
      m.assertEqual(containerProfile.Conditions.Count(), 1)
      m.assertEqual(containerProfile.Conditions[0].Condition, "NotEquals")
      m.assertEqual(containerProfile.Conditions[0].Property, "VideoRangeType")
      m.assertEqual(containerProfile.Conditions[0].Value, videoRangeType)
      m.assertTrue(containerProfile.Conditions[0].IsRequired)
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Device Capability Decisions")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("only checks for DOVI support on 4K devices")
    function _()
      ' Given: 1080p device (videoHeight < 2160)
      deviceVideoHeight = 1080

      ' When: Check if device should support DOVI
      shouldCheckDovi = deviceVideoHeight >= 2160

      ' Then: Should not check for DOVI support
      m.assertFalse(shouldCheckDovi, "Should not check for DOVI on 1080p devices")
    end function

    @it("checks for DOVI support on 4K devices")
    function _()
      ' Given: 4K device (videoHeight >= 2160)
      deviceVideoHeight = 2160

      ' When: Check if device should support DOVI
      shouldCheckDovi = deviceVideoHeight >= 2160

      ' Then: Should check for DOVI support
      m.assertTrue(shouldCheckDovi, "Should check for DOVI on 4K devices")
    end function

    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    @describe("Codec-Specific Handling")
    '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    @it("does NOT force remux for av1 codec even with DOVI content")
    function _()
      ' Given: MKV container with AV1 codec and DOVI VideoRangeType
      mediaStreams = [
        {
          Type: "Video",
          Codec: "av1",
          VideoRangeType: "DOVIWithSDR"
        }
      ]

      ' When: Check if stream should be processed for DOVI preservation
      ' The logic: stream.Type = "Video" AND stream.Codec <> "av1"
      shouldProcessDovi = false
      for each stream in mediaStreams
        if isValid(stream.Type) and stream.Type = "Video" and stream.Codec <> "av1"
          shouldProcessDovi = true
          exit for
        end if
      end for

      ' Then: Should NOT process DOVI logic for av1 codec
      m.assertFalse(shouldProcessDovi, "Should NOT force remux for av1 codec with DOVI")
    end function

    @it("DOES force remux for hevc codec with DOVI content")
    function _()
      ' Given: MKV container with HEVC codec and DOVI VideoRangeType
      mediaStreams = [
        {
          Type: "Video",
          Codec: "hevc",
          VideoRangeType: "DOVIWithHDR10"
        }
      ]

      ' When: Check if stream should be processed for DOVI preservation
      ' The logic: stream.Type = "Video" AND stream.Codec <> "av1"
      shouldProcessDovi = false
      for each stream in mediaStreams
        if isValid(stream.Type) and stream.Type = "Video" and stream.Codec <> "av1"
          shouldProcessDovi = true
          exit for
        end if
      end for

      ' Then: Should process DOVI logic for hevc codec
      m.assertTrue(shouldProcessDovi, "Should force remux for hevc codec with DOVI")
    end function

    @it("DOES force remux for h264 codec with DOVI content")
    function _()
      ' Given: MKV container with H264 codec and DOVI VideoRangeType
      mediaStreams = [
        {
          Type: "Video",
          Codec: "h264",
          VideoRangeType: "DOVI"
        }
      ]

      ' When: Check if stream should be processed for DOVI preservation
      ' The logic: stream.Type = "Video" AND stream.Codec <> "av1"
      shouldProcessDovi = false
      for each stream in mediaStreams
        if isValid(stream.Type) and stream.Type = "Video" and stream.Codec <> "av1"
          shouldProcessDovi = true
          exit for
        end if
      end for

      ' Then: Should process DOVI logic for h264 codec
      m.assertTrue(shouldProcessDovi, "Should force remux for h264 codec with DOVI")
    end function

  end class

end namespace

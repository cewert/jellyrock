# Consolidated workflow for all JellyRock-bot automated commits
# This workflow runs sequentially to avoid git conflicts when pushing to main
#
# Jobs:
# 1. build-translation: Updates translation files
# 2. update-settings-docs: Updates settings documentation (only when settings.json changes)
# 3. sync-changelog: Syncs changelog with unreleased changes

name: JellyRock Bot

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: jellyrock-bot-main
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Job 1: Translation Updates
  # ============================================================================
  build-translation:
    if: github.actor != 'JellyRock-bot'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Cache ropm dependencies
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: |
            source/roku_modules
            components/roku_modules
          key: ropm-${{ hashFiles('package.json', 'package-lock.json') }}
          restore-keys: ropm-

      - name: Install NPM dependencies
        run: npm ci

      - name: Generate translation file
        run: npm run update-translations

      - name: Check for translation changes
        id: check_changes
        run: |
          if git diff --quiet locale/en_US/translations.ts; then
            echo "â„¹ï¸ No translation changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Translation file has changes"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit translation changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "JellyRock-bot"
          git config user.email "c.ewert@gmail.com"
          git pull --rebase --autostash origin main
          git add locale/en_US/translations.ts
          git commit -m "chore(translation): Update en_US translation file"

      - name: Push to protected branch
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: CasperWA/push-protected@74d25b8aa10e0c29024138735d32f3c0b75f9279 # v2
        with:
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}
          branch: main
          unprotect_reviews: false

  # ============================================================================
  # Job 2: Settings Documentation Update
  # Only runs when settings/settings.json is modified
  # ============================================================================
  update-settings-docs:
    if: github.actor != 'JellyRock-bot'
    needs: build-translation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}
          fetch-depth: 0

      - name: Check if settings.json changed
        id: settings_check
        run: |
          # For workflow_dispatch, always run
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "settings_changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Manual trigger - checking settings docs"
            exit 0
          fi

          # For push events, check if settings.json changed
          if git diff --name-only HEAD~1 HEAD | grep -q "^settings/settings.json$"; then
            echo "settings_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… settings.json changed - will update docs"
          else
            echo "settings_changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  settings.json not changed - skipping docs update"
          fi

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        if: steps.settings_check.outputs.settings_changed == 'true'
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install dependencies
        if: steps.settings_check.outputs.settings_changed == 'true'
        run: npm ci

      - name: Regenerate settings docs
        if: steps.settings_check.outputs.settings_changed == 'true'
        run: npm run docs:settings

      - name: Check for settings docs changes
        if: steps.settings_check.outputs.settings_changed == 'true'
        id: check_changes
        run: |
          if git diff --quiet docs/user/app-settings.md; then
            echo "â„¹ï¸ No settings docs changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Settings docs have changes"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit settings docs changes
        if: steps.settings_check.outputs.settings_changed == 'true' && steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "JellyRock-bot"
          git config user.email "c.ewert@gmail.com"
          git pull --rebase --autostash origin main
          git add docs/user/app-settings.md
          git commit -m "chore(docs): auto-update settings docs"

      - name: Push to protected branch
        if: steps.settings_check.outputs.settings_changed == 'true' && steps.check_changes.outputs.has_changes == 'true'
        uses: CasperWA/push-protected@74d25b8aa10e0c29024138735d32f3c0b75f9279 # v2
        with:
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}
          branch: main
          unprotect_reviews: false

  # ============================================================================
  # Job 3: Changelog Sync
  # ============================================================================
  sync-changelog:
    if: github.actor != 'JellyRock-bot'
    needs: update-settings-docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Determine sync type
        id: sync_type
        run: |
          # Check if this push contains a new tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          PREVIOUS_HEAD=$(git rev-parse HEAD~1 2>/dev/null || echo "")

          if [ -n "$LATEST_TAG" ] && [ -n "$PREVIOUS_HEAD" ]; then
            # Check if the tag was created in this push (tag points to HEAD but not to previous HEAD)
            TAG_COMMIT=$(git rev-list -n 1 "$LATEST_TAG" 2>/dev/null || echo "")
            CURRENT_COMMIT=$(git rev-parse HEAD)

            if [ "$TAG_COMMIT" = "$CURRENT_COMMIT" ]; then
              # Check if this tag didn't exist in the previous commit
              if ! git merge-base --is-ancestor "$LATEST_TAG" "$PREVIOUS_HEAD" 2>/dev/null; then
                # New tag was created, extract version number
                VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
                echo "type=release" >> $GITHUB_OUTPUT
                echo "version=$VERSION" >> $GITHUB_OUTPUT
                echo "ðŸš€ New tag detected: $LATEST_TAG, processing as release $VERSION"
                exit 0
              fi
            fi
          fi

          # Default to unreleased
          echo "type=unreleased" >> $GITHUB_OUTPUT
          echo "ðŸ“ Push to main: processing as unreleased"

      - name: Sync release changes
        if: steps.sync_type.outputs.type == 'release'
        env:
          GH_TOKEN: ${{ secrets.JELLYROCK_BOT_TOKEN }}
        run: |
          echo "ðŸš€ Converting unreleased changes to release ${{ steps.sync_type.outputs.version }}..."
          npm run changelog:sync-release ${{ steps.sync_type.outputs.version }}

      - name: Sync unreleased changes
        if: steps.sync_type.outputs.type == 'unreleased'
        env:
          GH_TOKEN: ${{ secrets.JELLYROCK_BOT_TOKEN }}
        run: |
          echo "ðŸ”„ Syncing unreleased changes to changelog..."
          npm run changelog:sync-unreleased

      - name: Validate changelog
        run: |
          echo "ðŸ” Validating changelog consistency..."
          npm run changelog:validate

      - name: Commit changes if needed
        run: |
          if git diff --quiet HEAD -- CHANGELOG.md; then
            echo "â„¹ï¸ No changelog changes needed"
            echo "has_changes=false" >> $GITHUB_ENV
          else
            git config user.name "JellyRock-bot"
            git config user.email "c.ewert@gmail.com"
            git pull --rebase --autostash origin main
            git add CHANGELOG.md

            if [ "${{ steps.sync_type.outputs.type }}" = "release" ]; then
              echo "ðŸ“ Committing release changelog sync for v${{ steps.sync_type.outputs.version }}"
              git commit -m "chore:(docs) convert unreleased section to v${{ steps.sync_type.outputs.version }} release"
            else
              echo "ðŸ“ Committing unreleased changelog sync"
              git commit -m "chore:(docs) sync unreleased changelog entries"
            fi

            echo "has_changes=true" >> $GITHUB_ENV
          fi

      - name: Push changes to protected branch
        if: env.has_changes == 'true'
        uses: CasperWA/push-protected@74d25b8aa10e0c29024138735d32f3c0b75f9279 # v2
        with:
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}
          branch: main
          unprotect_reviews: false

      - name: Verify final state
        run: |
          echo "âœ… Changelog sync completed"
          echo "ðŸ“Š Final changelog state:"
          npm run changelog:status

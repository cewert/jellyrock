name: Update Draft Release

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  update-draft-release:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release-prep')
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from PR title
        id: extract_version
        run: |
          # Extract version from PR title like "Prepare for v1.21.3 release"
          PR_TITLE="${{ github.event.pull_request.title }}"
          VERSION=$(echo "$PR_TITLE" | sed -n 's/.*v\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')

          if [[ -z "$VERSION" ]]; then
            echo "‚ùå Could not extract version from PR title: $PR_TITLE"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted version: $VERSION"

      - name: Checkout merged code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: main
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build production app with updated version
        run: npm run build:prod

      - name: Create updated release ZIP
        id: create_zip
        run: |
          echo "üì¶ Preparing ZIP file for release..."
          ZIP_NAME="JellyRock-${{ steps.extract_version.outputs.tag_name }}.zip"
          if [[ -f "${{ github.workspace }}/out/jellyrock.zip" ]]; then
            cp "${{ github.workspace }}/out/jellyrock.zip" "${{ github.workspace }}/out/$ZIP_NAME"
            echo "‚úÖ ZIP renamed to: $ZIP_NAME"
          else
            echo "‚ùå Expected ZIP file not found at ./out/jellyrock.zip"
            ls -la ${{ github.workspace }}/out/ || echo "out directory not found"
            exit 1
          fi
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Update draft release with new ZIP
        env:
          GH_TOKEN: ${{ secrets.JELLYROCK_BOT_TOKEN }}
        run: |
          TAG_NAME="${{ steps.extract_version.outputs.tag_name }}"
          VERSION="${{ steps.extract_version.outputs.version }}"

          # Sync changelog to ensure unreleased section is up to date
          npm run changelog:sync-unreleased

          # Check if draft release exists
          RELEASE_INFO=$(gh release view "$TAG_NAME" --json isDraft,id 2>/dev/null || echo "")

          if [[ -z "$RELEASE_INFO" ]]; then
            echo "‚ùå No release found for $TAG_NAME"
            exit 1
          fi

          IS_DRAFT=$(echo "$RELEASE_INFO" | jq -r '.isDraft')

          if [[ "$IS_DRAFT" != "true" ]]; then
            echo "‚ö†Ô∏è Release $TAG_NAME is not a draft - skipping update"
            echo "This release may have already been published"
            exit 0
          fi

          # Use changelog syncer to format release notes (same logic as tag creation workflow)
          if [[ -f "CHANGELOG.md" ]]; then
            # Create temporary changelog to extract formatted release notes
            cp CHANGELOG.md CHANGELOG.md.backup
            node scripts/changelog-syncer.js sync-release "$VERSION"
            
            # Extract the newly created release section - handle the URL format correctly
            RELEASE_NOTES=$(sed -n "/## \[$VERSION\]/,/^## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)
            
            # Restore original changelog (don't commit changes in this workflow)
            mv CHANGELOG.md.backup CHANGELOG.md
            
            if [[ -z "$RELEASE_NOTES" || "$RELEASE_NOTES" == "" ]]; then
              RELEASE_NOTES="### No Changes Documented

              No changes were documented in CHANGELOG.md unreleased section."
            fi
          else
            RELEASE_NOTES="### No Changes Documented

            CHANGELOG.md not found."
          fi

          # Update the draft release with new ZIP and updated body
          # Calculate release date based on Roku release cycle (PT timezone)
          CURRENT_DAY_PT=$(TZ=America/Los_Angeles date +%A)

          # Determine days to add based on Roku release cycle
          case $CURRENT_DAY_PT in
            Monday)
              DAYS_TO_ADD=1  # Tuesday at 06:00 pm PT
              ;;
            Tuesday)
              DAYS_TO_ADD=1  # Wednesday at 06:00 pm PT
              ;;
            Wednesday)
              DAYS_TO_ADD=1  # Thursday at 06:00 pm PT
              ;;
            Thursday)
              DAYS_TO_ADD=1  # Friday at 06:00 pm PT
              ;;
            Friday)
              DAYS_TO_ADD=3  # Monday at 06:00 pm PT
              ;;
            Saturday)
              DAYS_TO_ADD=2  # Monday at 06:00 pm PT
              ;;
            Sunday)
              DAYS_TO_ADD=1  # Monday at 06:00 pm PT
              ;;
          esac

          # Calculate release date in PT timezone
          RELEASE_DATE=$(TZ=America/Los_Angeles date -d "+${DAYS_TO_ADD} days" +"%A, %B %d, %Y")

          UPDATED_BODY="## Release Schedule

          JellyRock $TAG_NAME is scheduled for release on the [Roku Channel Store](https://channelstore.roku.com/details/232f9e82db11ce628e3fe7e01382a330:a85d6e9e520567806e8dae1c0cabadd5/jellyrock) $RELEASE_DATE 6:00 PM PT

          $RELEASE_NOTES"

          # Upload the new ZIP to the existing draft release
          gh release upload "$TAG_NAME" "out/${{ steps.create_zip.outputs.zip_name }}" --clobber

          # Update release body
          gh release edit "$TAG_NAME" --notes "$UPDATED_BODY"

          echo "‚úÖ Updated draft release $TAG_NAME with new ZIP"
          echo "üìù The release is ready for you to add the scheduled date and publish!"

name: Finalize Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  finalize-release:
    runs-on: ubuntu-latest
    concurrency:
      group: bot-release-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}
          fetch-depth: 0

      - name: Extract version info
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Finalizing release for version $VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Update changelog for release
        run: |
          echo "ðŸ“ Converting unreleased changes to release ${{ steps.version.outputs.version }}"
          node scripts/changelog-syncer.js sync-release "${{ steps.version.outputs.version }}"

      - name: Commit changelog update
        run: |
          git config user.name "JellyRock-bot"
          git config user.email "c.ewert@gmail.com"

          if git diff --quiet CHANGELOG.md; then
            echo "â„¹ï¸ No changelog changes to commit"
            echo "has_changes=false" >> $GITHUB_ENV
          else
            # Switch to main branch and apply the changelog changes
            git stash push -m "changelog updates" CHANGELOG.md
            git checkout main
            git pull --rebase origin main
            git stash pop

            git add CHANGELOG.md
            git commit -m "chore:(docs) finalize changelog for v${{ steps.version.outputs.version }}"
            echo "has_changes=true" >> $GITHUB_ENV
            echo "âœ… Prepared changelog for release ${{ steps.version.outputs.version }}"
          fi

      - name: Push changelog to protected branch
        if: env.has_changes == 'true'
        uses: CasperWA/push-protected@74d25b8aa10e0c29024138735d32f3c0b75f9279 # v2
        with:
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}
          branch: main
          unprotect_reviews: false

      - name: Release Summary
        run: |
          echo "ðŸŽ‰ Release ${{ steps.version.outputs.version }} finalized!"
          echo "ðŸ“‹ Changelog updated with release notes"
          echo "ðŸ”— Release published at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag_name }}"

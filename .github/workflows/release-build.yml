name: Finalize Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  finalize-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}
          fetch-depth: 0

      - name: Extract version info
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Finalizing release for version $VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Update changelog for release
        run: |
          echo "ğŸ“ Converting unreleased changes to release ${{ steps.version.outputs.version }}"
          node scripts/changelog-syncer.js sync-release "${{ steps.version.outputs.version }}"

      - name: Commit changelog update
        run: |
          git config user.name "JellyRock-bot"
          git config user.email "c.ewert@gmail.com"

          if git diff --quiet CHANGELOG.md; then
            echo "â„¹ï¸ No changelog changes to commit"
          else
            # Switch to main branch and apply the changelog changes
            git stash push -m "changelog updates" CHANGELOG.md
            git checkout main
            git stash pop
            
            git add CHANGELOG.md
            git commit -m "chore:(docs) finalize changelog for v${{ steps.version.outputs.version }} [skip ci]"
            git push origin main
            echo "âœ… Updated changelog for release ${{ steps.version.outputs.version }}"
          fi

      - name: Release Summary
        run: |
          echo "ğŸ‰ Release ${{ steps.version.outputs.version }} finalized!"
          echo "ğŸ“‹ Changelog updated with release notes"
          echo "ğŸ”— Release published at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag_name }}"

name: Changelog Sync

on:
  push:
    branches:
      - main

jobs:
  sync-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Determine sync type
        id: sync_type
        run: |
          # Check if this push contains a new tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          PREVIOUS_HEAD=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$LATEST_TAG" ] && [ -n "$PREVIOUS_HEAD" ]; then
            # Check if the tag was created in this push (tag points to HEAD but not to previous HEAD)
            TAG_COMMIT=$(git rev-list -n 1 "$LATEST_TAG" 2>/dev/null || echo "")
            CURRENT_COMMIT=$(git rev-parse HEAD)
            
            if [ "$TAG_COMMIT" = "$CURRENT_COMMIT" ]; then
              # Check if this tag didn't exist in the previous commit
              if ! git merge-base --is-ancestor "$LATEST_TAG" "$PREVIOUS_HEAD" 2>/dev/null; then
                # New tag was created, extract version number
                VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
                echo "type=release" >> $GITHUB_OUTPUT
                echo "version=$VERSION" >> $GITHUB_OUTPUT
                echo "🚀 New tag detected: $LATEST_TAG, processing as release $VERSION"
                exit 0
              fi
            fi
          fi
          
          # Default to unreleased
          echo "type=unreleased" >> $GITHUB_OUTPUT
          echo "📝 Push to main: processing as unreleased"

      - name: Sync release changes
        if: steps.sync_type.outputs.type == 'release'
        env:
          GH_TOKEN: ${{ secrets.JELLYROCK_BOT_TOKEN }}
        run: |
          echo "🚀 Converting unreleased changes to release ${{ steps.sync_type.outputs.version }}..."
          npm run changelog:sync-release ${{ steps.sync_type.outputs.version }}

      - name: Sync unreleased changes
        if: steps.sync_type.outputs.type == 'unreleased'
        env:
          GH_TOKEN: ${{ secrets.JELLYROCK_BOT_TOKEN }}
        run: |
          echo "🔄 Syncing unreleased changes to changelog..."
          npm run changelog:sync-unreleased

      - name: Validate changelog
        run: |
          echo "🔍 Validating changelog consistency..."
          npm run changelog:validate

      - name: Commit changes if needed
        run: |
          if git diff --quiet HEAD -- CHANGELOG.md; then
            echo "ℹ️ No changelog changes needed"
            echo "has_changes=false" >> $GITHUB_ENV
          else
            git config user.name "JellyRock-bot"
            git config user.email "c.ewert@gmail.com"
            git add CHANGELOG.md

            if [ "${{ steps.sync_type.outputs.type }}" = "release" ]; then
              echo "📝 Committing release changelog sync for v${{ steps.sync_type.outputs.version }}"
              git commit -m "chore:(docs) convert unreleased section to v${{ steps.sync_type.outputs.version }} release"
            else
              echo "📝 Committing unreleased changelog sync"
              git commit -m "chore:(docs) sync unreleased changelog entries"
            fi

            echo "has_changes=true" >> $GITHUB_ENV
          fi

      - name: Push changes to protected branch
        if: env.has_changes == 'true'
        uses: CasperWA/push-protected@v2
        with:
          token: ${{ secrets.JELLYROCK_BOT_TOKEN }}
          branch: main
          unprotect_reviews: false

      - name: Verify final state
        run: |
          echo "✅ Changelog sync completed"
          echo "📊 Final changelog state:"
          npm run changelog:status
